<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STCEx Swap ‚Üí STC Auto Staking (Maturity)</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <style>
    body{margin:0;background:#070707;color:#f5d36a;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{background:#0f0f0f;border:1px solid #2a2414;border-radius:14px;padding:16px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #3a2f14;background:#090909;color:#ffe39a}
    button{padding:12px 14px;border-radius:12px;border:1px solid #6b551f;background:#15110a;color:#f5d36a;cursor:pointer}
    button:hover{filter:brightness(1.1)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .muted{color:#b79b54;font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:820px){.grid{grid-template-columns:1fr}}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #3a2f14;background:#0b0b0b}
    a{color:#f5d36a}
  </style>
</head>
<body>
<div class="wrap">
  <h2>üü° STCEx Swap ‚Üí STC Auto Staking (‡πÄ‡∏Ñ‡∏•‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤)</h2>

  <div class="card">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div>
        <div class="muted">Wallet</div>
        <div id="wallet" class="mono">‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
      </div>
      <button id="btnConnect">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤</button>
    </div>

    <div class="muted" style="margin-top:10px;line-height:1.6">
      Contract: <span id="contract" class="mono">-</span><br/>
      Explorer: <a id="scanContract" href="#" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Contract</a>
      &nbsp;|&nbsp; Wallet: <a id="scanWallet" href="#" target="_blank">‡πÄ‡∏õ‡∏¥‡∏î Wallet</a>
    </div>

    <div class="muted" style="margin-top:10px">
      Network: <span id="net" class="mono">-</span>
      &nbsp;|&nbsp; Owner: <span id="owner" class="mono">-</span>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>1) Swap USDT ‚Üí STCEx</h3>
      <div class="muted">‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (Owner ‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ) ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div>

      <div style="margin-top:10px">
        <div class="muted">USDT amount</div>
        <input id="usdtIn" placeholder="‡πÄ‡∏ä‡πà‡∏ô 50" inputmode="decimal" />
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApproveUSDT">Approve USDT</button>
        <button id="btnSwap">Swap</button>
      </div>

      <div class="muted" style="margin-top:10px;line-height:1.7">
        USDT Balance: <span id="balUSDT" class="mono">-</span><br/>
        STCEx Balance: <span id="balSTCEx" class="mono">-</span>
      </div>

      <div class="muted" style="margin-top:10px;line-height:1.7">
        Current rates:<br/>
        stcexPerUsdt: <span id="rate1" class="mono">-</span><br/>
        stcPerStcex: <span id="rate2" class="mono">-</span>
      </div>
    </div>

    <div class="card">
      <h3>2) Stake STCEx ‚Üí STC</h3>
      <div class="muted">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 10 STCEx ‚Ä¢ ‡∏î‡∏≠‡∏Å‡∏™‡∏∞‡∏™‡∏° ‚Ä¢ ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>

      <div style="margin-top:10px">
        <div class="muted">STCEx amount to stake</div>
        <input id="stcexIn" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10" inputmode="decimal" />
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnApproveSTCEx">Approve STCEx</button>
        <button id="btnStake">Stake</button>
      </div>

      <div class="muted" style="margin-top:10px;line-height:1.7">
        STC Balance: <span id="balSTC" class="mono">-</span><br/>
        minStakeSTCEx: <span id="minStake" class="mono">-</span>
      </div>

      <div class="muted" style="margin-top:10px;line-height:1.7">
        lockSeconds: <span id="lock" class="mono">-</span><br/>
        periodSeconds: <span id="period" class="mono">-</span><br/>
        rewardBps: <span id="bps" class="mono">-</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Staking (‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏≠‡∏¢‡∏´‡∏•‡∏±‡∏á)</h3>

    <div class="row">
      <div class="pill">Principal (STC): <span id="principal" class="mono">-</span></div>
      <div class="pill">Accrued Reward (STC): <span id="accrued" class="mono">-</span></div>
      <div class="pill">Periods (30d): <span id="periods" class="mono">-</span></div>
      <div class="pill">Matured: <span id="matured" class="mono">-</span></div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="pill">Unlock in: <span id="unlockCd" class="mono">-</span></div>
      <div class="pill">UnlockAt: <span id="unlockAt" class="mono">-</span></div>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="btnWithdrawAll">Withdraw All (‡∏Ñ‡∏£‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤: ‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å)</button>
      <button id="btnRefresh">Refresh</button>
    </div>

    <div class="muted" style="margin-top:10px" id="status">-</div>
  </div>
</div>

<script>
/** ====== CONFIG (yours) ====== */
const CFG = {
  CHAIN_ID_HEX: "0x38",
  CHAIN_ID_DEC: 56,
  EXPLORER: "https://bscscan.com",

  CONTRACT: "0x44Db9CCD70D6ADbfC27Ba1B55c20abAe9cf28267",

  USDT:  "0x55d398326f99059fF775485246999027B3197955",
  STCEx: "0xAD01f5c7a87460229c3Dc70a7259E16FA1E260a2",
  STC:   "0x12730990De18c6864e45d22f007EBebaFbf6c76b"
};

/** ====== ABIs ====== */
const ERC20_ABI = [
  "function decimals() view returns(uint8)",
  "function balanceOf(address) view returns(uint256)",
  "function allowance(address owner,address spender) view returns(uint256)",
  "function approve(address spender,uint256) returns(bool)"
];

const STAKE_ABI = [
  "function owner() view returns(address)",
  "function stcexPerUsdt() view returns(uint256)",
  "function stcPerStcex() view returns(uint256)",
  "function minStakeSTCEx() view returns(uint256)",
  "function lockSeconds() view returns(uint256)",
  "function periodSeconds() view returns(uint256)",
  "function rewardBps() view returns(uint256)",

  "function swapUSDTToSTCEx(uint256 usdtAmount)",
  "function stakeWithSTCEx(uint256 stcexAmount)",
  "function withdrawAllAfterMaturity()",

  "function users(address) view returns(uint256 stakedSTC,uint256 startTime)",
  "function accruedRewardSTC(address user) view returns(uint256 reward,uint256 periods)",
  "function timeUntilUnlock(address user) view returns(uint256)",
  "function unlockAt(address user) view returns(uint256)",
  "function matured(address user) view returns(bool)"
];

/** ====== State ====== */
let provider, signer, user;
let usdt, stcex, stc, stake;
let decUSDT=18, decSTCEx=18, decSTC=18;
let tickTimer=null;

/** ====== DOM helpers ====== */
const $ = (id)=>document.getElementById(id);
const setStatus = (t)=>{ $("status").textContent = t; };

/** ====== Utils ====== */
function fmtUnits(v, dec, p=6){
  try{
    const s = ethers.formatUnits(v, dec);
    const n = Number(s);
    if (!isFinite(n)) return s;
    return n.toLocaleString(undefined,{maximumFractionDigits:p});
  }catch{ return "-"; }
}
function parseUnitsSafe(str, dec){
  const s = (str||"").trim();
  if(!s) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô");
  return ethers.parseUnits(s, dec);
}
function fmtDuration(sec){
  sec = Number(sec||0);
  if(sec<=0) return "00:00:00";
  const d = Math.floor(sec/86400); sec -= d*86400;
  const h = Math.floor(sec/3600);  sec -= h*3600;
  const m = Math.floor(sec/60);    sec -= m*60;
  const pad = (x)=>String(x).padStart(2,"0");
  return (d>0? `${d}d `:"") + `${pad(h)}:${pad(m)}:${pad(sec)}`;
}
function fmtDateFromUnix(ts){
  try{
    if(!ts || ts==0n) return "-";
    const d = new Date(Number(ts) * 1000);
    return d.toLocaleString();
  }catch{ return "-"; }
}

async function ensureBSC(){
  if(!window.ethereum) throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö Wallet (MetaMask/Bitget)");
  const chainId = await window.ethereum.request({ method:"eth_chainId" });
  if(chainId !== CFG.CHAIN_ID_HEX){
    await window.ethereum.request({
      method:"wallet_switchEthereumChain",
      params:[{ chainId: CFG.CHAIN_ID_HEX }]
    });
  }
}

/** ====== Core refresh ====== */
async function refreshStatic(){
  $("contract").textContent = CFG.CONTRACT;
  $("scanContract").href = `${CFG.EXPLORER}/address/${CFG.CONTRACT}`;
  if(user) $("scanWallet").href = `${CFG.EXPLORER}/address/${user}`;

  const net = await provider.getNetwork();
  $("net").textContent = `${net.name || "BSC"} (${Number(net.chainId)})`;

  const [own, r1, r2, minS, lockS, perS, bps] = await Promise.all([
    stake.owner(),
    stake.stcexPerUsdt(),
    stake.stcPerStcex(),
    stake.minStakeSTCEx(),
    stake.lockSeconds(),
    stake.periodSeconds(),
    stake.rewardBps()
  ]);

  $("owner").textContent = own;
  $("rate1").textContent = r1.toString();
  $("rate2").textContent = r2.toString();
  $("minStake").textContent = fmtUnits(minS, decSTCEx, 6);

  $("lock").textContent = `${Number(lockS)} sec`;
  $("period").textContent = `${Number(perS)} sec`;
  $("bps").textContent = bps.toString();
}

async function refreshBalances(){
  if(!user) return;
  const [bU,bE,bS] = await Promise.all([
    usdt.balanceOf(user),
    stcex.balanceOf(user),
    stc.balanceOf(user)
  ]);
  $("balUSDT").textContent  = fmtUnits(bU, decUSDT);
  $("balSTCEx").textContent = fmtUnits(bE, decSTCEx);
  $("balSTC").textContent   = fmtUnits(bS, decSTC);
}

async function refreshStakeInfo(){
  if(!user) return;

  const u = await stake.users(user);
  const principal = u[0];
  $("principal").textContent = fmtUnits(principal, decSTC);

  const [acc, tUnlock, ua, isMat] = await Promise.all([
    stake.accruedRewardSTC(user),
    stake.timeUntilUnlock(user),
    stake.unlockAt(user),
    stake.matured(user)
  ]);

  $("accrued").textContent = fmtUnits(acc[0], decSTC);
  $("periods").textContent = String(acc[1]);
  $("unlockCd").textContent = fmtDuration(tUnlock);
  $("unlockAt").textContent = fmtDateFromUnix(ua);
  $("matured").textContent = isMat ? "‚úÖ YES" : "‚è≥ NO";

  // enable withdraw only if matured
  $("btnWithdrawAll").disabled = !isMat;
}

/** ====== Countdown tick (1s) ====== */
async function startTick(){
  if(tickTimer) clearInterval(tickTimer);
  tickTimer = setInterval(async ()=>{
    try{
      if(!user) return;
      const [tUnlock, isMat] = await Promise.all([
        stake.timeUntilUnlock(user),
        stake.matured(user)
      ]);
      $("unlockCd").textContent = fmtDuration(tUnlock);
      $("matured").textContent = isMat ? "‚úÖ YES" : "‚è≥ NO";
      $("btnWithdrawAll").disabled = !isMat;
    }catch{}
  }, 1000);
}

/** ====== Approve helper ====== */
async function approveToken(token, amountWei){
  const a = await token.allowance(user, CFG.CONTRACT);
  if(a >= amountWei) return;
  const tx = await token.approve(CFG.CONTRACT, amountWei);
  setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á Approve... " + tx.hash);
  await tx.wait();
  setStatus("Approve ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
}

/** ====== Actions ====== */
async function connect(){
  try{
    await ensureBSC();
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    user = await signer.getAddress();

    usdt  = new ethers.Contract(CFG.USDT, ERC20_ABI, signer);
    stcex = new ethers.Contract(CFG.STCEx, ERC20_ABI, signer);
    stc   = new ethers.Contract(CFG.STC, ERC20_ABI, signer);
    stake = new ethers.Contract(CFG.CONTRACT, STAKE_ABI, signer);

    decUSDT  = await usdt.decimals();
    decSTCEx = await stcex.decimals();
    decSTC   = await stc.decimals();

    $("wallet").textContent = user;
    $("scanWallet").href = `${CFG.EXPLORER}/address/${user}`;

    setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");

    await refreshStatic();
    await refreshBalances();
    await refreshStakeInfo();
    await startTick();
  }catch(e){
    setStatus("‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onApproveUSDT(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    const amt = parseUnitsSafe($("usdtIn").value, decUSDT);
    await approveToken(usdt, amt);
  }catch(e){
    setStatus("Approve USDT ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onSwap(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    const amt = parseUnitsSafe($("usdtIn").value, decUSDT);

    await approveToken(usdt, amt);

    const tx = await stake.swapUSDTToSTCEx(amt);
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á Swap... " + tx.hash);
    await tx.wait();

    setStatus("Swap ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    await refreshBalances();
  }catch(e){
    setStatus("Swap ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onApproveSTCEx(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    const amt = parseUnitsSafe($("stcexIn").value, decSTCEx);
    await approveToken(stcex, amt);
  }catch(e){
    setStatus("Approve STCEx ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onStake(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    const amt = parseUnitsSafe($("stcexIn").value, decSTCEx);

    await approveToken(stcex, amt);

    const tx = await stake.stakeWithSTCEx(amt);
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á Stake... " + tx.hash);
    await tx.wait();

    setStatus("Stake ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ");
    await refreshBalances();
    await refreshStakeInfo();
  }catch(e){
    setStatus("Stake ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onWithdrawAll(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");

    const isMat = await stake.matured(user);
    if(!isMat) return setStatus("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤ (‡∏¢‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)");

    const tx = await stake.withdrawAllAfterMaturity();
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á Withdraw... " + tx.hash);
    await tx.wait();

    setStatus("Withdraw ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ (‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å)");
    await refreshBalances();
    await refreshStakeInfo();
  }catch(e){
    setStatus("Withdraw ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

async function onRefresh(){
  try{
    if(!user) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
    await refreshStatic();
    await refreshBalances();
    await refreshStakeInfo();
    setStatus("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚úÖ");
  }catch(e){
    setStatus("Refresh ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (e?.shortMessage||e?.message||e));
  }
}

/** ====== Bind ====== */
$("btnConnect").onclick = connect;
$("btnApproveUSDT").onclick = onApproveUSDT;
$("btnSwap").onclick = onSwap;
$("btnApproveSTCEx").onclick = onApproveSTCEx;
$("btnStake").onclick = onStake;
$("btnWithdrawAll").onclick = onWithdrawAll;
$("btnRefresh").onclick = onRefresh;
</script>
</body>
</html>
